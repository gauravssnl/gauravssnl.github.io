<!DOCTYPE html>
<html lang="english">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../../../theme/css/style.min.css?fc5adb95">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="gauravssnl" />

        <meta name="twitter:creator" content="@gauravssnl">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Newtork Programming, Rust, Socket, TcpStream, Networking, Uncategorized, " />

<meta property="og:title" content="Rust - How to read all the data of a TcpStream (socket) completely ? "/>
<meta property="og:url" content="../../../2020/11/03/rust-how-to-read-all-the-data-of-a-tcpstream-socket-completely" />
<meta property="og:description" content="Hi everyone. I have started learning Rust and I tried creating a project RServer which is an app for intercepting/capturing TCP requests sent by browser and other apps running on a system. While developing RServer , I faced an issue while trying to read the complete data from a TcpStream …" />
<meta property="og:site_name" content="Gauravssnl Tech Blog" />
<meta property="og:article:author" content="gauravssnl" />
<meta property="og:article:published_time" content="2020-11-03T11:47:00+05:30" />
<meta name="twitter:title" content="Rust - How to read all the data of a TcpStream (socket) completely ? ">
<meta name="twitter:description" content="Hi everyone. I have started learning Rust and I tried creating a project RServer which is an app for intercepting/capturing TCP requests sent by browser and other apps running on a system. While developing RServer , I faced an issue while trying to read the complete data from a TcpStream …">

        <title>Rust - How to read all the data of a TcpStream (socket) completely ?  · Gauravssnl Tech Blog
</title>


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="../../../"><span class=site-name>Gauravssnl Tech Blog</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       ../../..
                                    >Home</a>
                                </li>
                                <li ><a href="../../../pages/about.html">About</a></li>
                                <li ><a href="../../../categories.html">Categories</a></li>
                                <li ><a href="../../../tags.html">Tags</a></li>
                                <li ><a href="../../../archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="../../../search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="../../../2020/11/03/rust-how-to-read-all-the-data-of-a-tcpstream-socket-completely">
                Rust - How to read all the data of a   TcpStream (socket) completely ?
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Hi everyone. I have started learning Rust and I tried creating a project <a href="https://github.com/gauravssnl/rserver">RServer</a> which is an app for intercepting/capturing TCP requests sent by browser and other apps running on a system. While developing <a href="https://github.com/gauravssnl/rserver">RServer</a> , I faced an issue while trying to read the complete data from a <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> struct. <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> has only <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html#impl-Read">read</a> method , but socket /TCP streams constructs do not have method such as <strong>read_all</strong> to read all the data from the stream. In this post, I am going to share my technique which I used in <a href="https://github.com/gauravssnl/rserver">RServer</a> .</p>
<p>As we do not have any built-in method to read the <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> completely in one go , we obviously need to use some kind of loop to read the complete data from a given stream. Let us consider that we want to read all the data and we need to return the data and its length/size.</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="sd">/// Read the stream data and return stream data &amp; its length</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">read_stream</span><span class="p">(</span><span class="n">stream</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">TcpStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="nb">Vec</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">request_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">[];</span><span class="w"></span>
<span class="w">        </span><span class="c1">// let us loop &amp; try to read the whole request data</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">request_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">usize</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">request_len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>

<span class="w">                        </span><span class="c1">// we need not read more data in case we have read less data than buffer size</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Error in reading stream data: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="p">(</span><span class="n">request_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">request_len</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>


<p>Explanation :</p>
<p>I have taken an initial buffer size as 512 as an example, we will be reading 512 bytes or lesser in one go from the stream. I have taken a mutable Vector here as we cannot determine the <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> data size/length in advance as we are reading data via network. Most of the other examples available might be using an array, but that might lead to either wastage of some space or there will be space scarcity to read all the data and store the data into the array as the size might be more or lesser than the required space. I am storing the length of the data which we read in a variable <strong>request_len</strong> .</p>
<p>I am using a mutable temporary Vector variable buffer and try reading the 512 bytes inside a loop, then we are using a match pattern while reading the data to know the number of bytes of data which were read. Depending on the number of bytes read from <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a>, which is n here, the corresponding code placed in the arm of the match block will be executed. If n is 0, i.e there is no data and nothing was read, we just need to break out of the loop and stop reading the stream. Otherwise, we just add the number of bytes read to the variable <strong>request_len</strong> . If n is lesser than the buffer size (512 here), we understand that the Stream has lesser data than our buffer size, we add the data how much ever it was there , by adding the <strong>mut buffer[..n]</strong> to the mutable vector <strong>request_buffer</strong> and then we break out of the loop as we have no more data under the current iteration of the loop. If n is equal to our buffer size ( 512 here), we read the data and add the data into mutable vector <strong>request_buffer</strong> . In this case, we don't break out of the loop and try reading more data out of the <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> if available .</p>
<p>I hope this post will be useful to you all who are learning Rust <a href="https://en.wikipedia.org/wiki/Network_socket">socket</a> / <a href="https://doc.rust-lang.org/std/net/struct.TcpStream.html">TcpStream</a> programming . The same concept can be used for reading data from <a href="https://en.wikipedia.org/wiki/Network_socket">socket</a> in other languages too. Thanks for reading the post. Please post your questions and ideas in comments. Feel free to reach out to me if you have better ways of doing this or for any questions. Follow me on <a href="https://twitter.com/gauravssnl">Twitter</a> for more updates and if you want to connect with me.</p>


             
 
                <p id="post-share-links">
    Share on:
      <a href="https://twitter.com/intent/tweet?text=Rust%20-%20How%20to%20read%20all%20the%20data%20of%20a%20%20%20TcpStream%20%28socket%29%20completely%20%3F&url=https%3A//gauravssnl.github.io/2020/11/03/rust-how-to-read-all-the-data-of-a-tcpstream-socket-completely&via=gauravssnl&hashtags=newtork-programming,rust,socket,tcpstream" target="_blank" rel="nofollow noopener noreferrer" title="Share on Twitter">Twitter</a>
 ❄       <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//gauravssnl.github.io/2020/11/03/rust-how-to-read-all-the-data-of-a-tcpstream-socket-completely" target="_blank" rel="nofollow noopener noreferrer" title="Share on Facebook">Facebook</a>
 ❄       <a href="mailto:?subject=Rust%20-%20How%20to%20read%20all%20the%20data%20of%20a%20%20%20TcpStream%20%28socket%29%20completely%20%3F&amp;body=https%3A//gauravssnl.github.io/2020/11/03/rust-how-to-read-all-the-data-of-a-tcpstream-socket-completely" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>

            
            







            <hr/>
<section>
    <h2>Related Posts</h2>
<ul class="related-posts-list">
<li><a href="../../../2020/06/24/install-visual-studio-for-c-c-and-rust-development-on-windows-os" title="Install Visual Studio for C , C++ and Rust Development on Windows OS">Install Visual Studio for C , C++ and Rust Development on Windows OS</a></li>
<li><a href="../../../2020/10/26/rust-development-environment-setup" title="Rust Development Environment Setup">Rust Development Environment Setup</a></li>
<li><a href="../../../2021/01/11/hello" title="Hello World!">Hello World!</a></li>
</ul>
<hr />
</section>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="../../../2020/10/26/rust-development-environment-setup" title="Previous: Rust Development Environment Setup">Rust Development Environment Setup</a></li>
                <li class="next-article"><a href="../../../2021/01/11/hello" title="Next: Hello World!">Hello World!</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-11-03T11:47:00+05:30">Tue 03 November 2020</time>
            <h4>Category</h4>
            <a class="category-link" href="../../../categories.html#networking-uncategorized-ref">Networking, Uncategorized</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="../../../tags.html#newtork-programming-ref">Newtork Programming
                    <span class="superscript">1</span>
</a></li>
                <li><a href="../../../tags.html#rust-ref">Rust
                    <span class="superscript">4</span>
</a></li>
                <li><a href="../../../tags.html#socket-ref">Socket
                    <span class="superscript">1</span>
</a></li>
                <li><a href="../../../tags.html#tcpstream-ref">TcpStream
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/gauravssnl" title="Github" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/gauravssnl/" title="LinkedIn" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://twitter.com/gauravssnl" title="Twitter" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="mailto:gauravssnl@gmail.com" title="My Email Address" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#328cff"/><path d="m250 186c-46 0-69 35-69 74 0 44 29 72 68 72 43 0 73-32 73-75 0-44-34-71-72-71zm-1-37c30 0 57 13 77 33 0-22 35-22 35 1v150c-1 10 10 16 16 9 25-25 54-128-14-187-64-56-149-47-195-15-48 33-79 107-49 175 33 76 126 99 182 76 28-12 41 26 12 39-45 19-168 17-225-82-38-68-36-185 67-248 78-46 182-33 244 32 66 69 62 197-2 246-28 23-71 1-71-32v-11c-20 20-47 32-77 32-57 0-108-51-108-108 0-58 51-110 108-110" fill="#fff"/></svg>
    </a>
    <a href="https://gauravssnl.github.io/feeds/all.atom.xml" title="RSS" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        
&copy; Copyright 2020 by Gaurav (@gauravssnl) and licensed under a <a rel="license"
  href="http://creativecommons.org/licenses/by/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" />
  Creative Commons Attribution 4.0 International License</a>.

    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="../../../theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>